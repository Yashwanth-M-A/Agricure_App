/**
 * @file AgriAssist Firestore Security Rules
 * @version Prototyping
 *
 * @description
 * This ruleset enforces a strict user-ownership model, ensuring that only the authenticated user can access their own data.
 *
 * Data Structure:
 * All data is nested under `/users/{userId}`, creating a hierarchical structure that simplifies security rules.
 * - User profiles are stored at `/users/{userId}`.
 * - Farms are stored at `/users/{userId}/farms/{farmId}`.
 * - Crops are stored at `/users/{userId}/farms/{farmId}/crops/{cropId}`.
 * - Family members are stored at `/users/{userId}/familyMembers/{familyMemberId}`.
 * - Communication preferences are stored at `/users/{userId}/communicationPreference`.
 * - Emergency contacts are stored at `/users/{userId}/emergencyContacts/{emergencyContactId}`.
 *
 * Key Security Decisions:
 * - User listing is implicitly disallowed by the absence of a top-level `/users` collection rule.
 * - All data is private to the user and relies on path-based ownership.
 * - No denormalization is required as all authorization checks are based on the user's ID.
 * - Schema validation is relaxed to allow for rapid prototyping, focusing only on critical authorization fields.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Secures user profiles, ensuring only the authenticated user can access their own profile data.
     * @path /users/{userId}
     * @allow (create) - Authenticated user creates their profile with matching userId.
     *   request.auth.uid: "user123"
     *   request.resource.data: { "id": "user123", ... }
     * @allow (get, update, delete) - Authenticated user accesses their own profile.
     *   request.auth.uid: "user123"
     * @deny (create) - User attempts to create a profile with a mismatched userId.
     *   request.auth.uid: "user456"
     *   request.resource.data: { "id": "user123", ... }
     * @deny (get, update, delete) - Unauthorized user attempts to access another user's profile.
     *   request.auth.uid: "user456"
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      // Helper function to check if the user is signed in
      function isSignedIn() {
        return request.auth != null;
      }

      // Helper function to check if the authenticated user ID matches the document ID
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      // Helper function to check if the user is the owner and the document exists
      function isExistingOwner(userId) {
        return isOwner(userId) && exists(/databases/$(database)/documents/users/$(userId));
      }

      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isExistingOwner(userId);
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }

    /**
     * @description Secures farm data for a specific user, ensuring only the owner can access and modify it.
     * @path /users/{userId}/farms/{farmId}
     * @allow (create) - Authenticated user creates a farm under their user ID.
     *   request.auth.uid: "user123"
     *   request.resource.data: { "userId": "user123", ... }
     * @allow (get, update, delete) - Authenticated user accesses their own farm.
     *   request.auth.uid: "user123"
     * @deny (create) - User attempts to create a farm under another user's ID.
     *   request.auth.uid: "user456"
     *   request.resource.data: { "userId": "user123", ... }
     * @deny (get, update, delete) - Unauthorized user attempts to access another user's farm.
     *   request.auth.uid: "user456"
     * @principle Enforces document ownership for all operations on farm data.
     */
    match /users/{userId}/farms/{farmId} {
      // Reuse the isOwner and isSignedIn functions defined above
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && exists(/databases/$(database)/documents/users/$(userId)/farms/$(farmId));
      }
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isExistingOwner(userId);
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }

    /**
     * @description Secures crop data for a specific farm and user, ensuring only the owner can access and modify it.
     * @path /users/{userId}/farms/{farmId}/crops/{cropId}
     * @allow (create) - Authenticated user creates a crop under their farm and user ID.
     *   request.auth.uid: "user123"
     *   request.resource.data: { "farmId": "farm456", ... }
     * @allow (get, update, delete) - Authenticated user accesses their own crop.
     *   request.auth.uid: "user123"
     * @deny (create) - User attempts to create a crop under another user's farm.
     *   request.auth.uid: "user456"
     *   request.resource.data: { "farmId": "farm789", ... }
     * @deny (get, update, delete) - Unauthorized user attempts to access another user's crop.
     *   request.auth.uid: "user456"
     * @principle Enforces document ownership for all operations on crop data.
     */
    match /users/{userId}/farms/{farmId}/crops/{cropId} {
      // Reuse the isOwner and isSignedIn functions defined above
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && exists(/databases/$(database)/documents/users/$(userId)/farms/$(farmId)/crops/$(cropId));
      }

      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isExistingOwner(userId);
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }

    /**
     * @description Secures family member data for a specific user, ensuring only the owner can access and modify it.
     * @path /users/{userId}/familyMembers/{familyMemberId}
     * @allow (create) - Authenticated user creates a family member under their user ID.
     *   request.auth.uid: "user123"
     *   request.resource.data: { "userId": "user123", ... }
     * @allow (get, update, delete) - Authenticated user accesses their own family member data.
     *   request.auth.uid: "user123"
     * @deny (create) - User attempts to create a family member under another user's ID.
     *   request.auth.uid: "user456"
     *   request.resource.data: { "userId": "user123", ... }
     * @deny (get, update, delete) - Unauthorized user attempts to access another user's family member data.
     *   request.auth.uid: "user456"
     * @principle Enforces document ownership for all operations on family member data.
     */
    match /users/{userId}/familyMembers/{familyMemberId} {
      // Reuse the isOwner and isSignedIn functions defined above
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && exists(/databases/$(database)/documents/users/$(userId)/familyMembers/$(familyMemberId));
      }

      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isExistingOwner(userId);
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }

    /**
     * @description Secures communication preferences for a specific user, ensuring only the owner can access and modify them.
     * @path /users/{userId}/communicationPreference
     * @allow (create) - Authenticated user creates their communication preferences under their user ID.
     *   request.auth.uid: "user123"
     *   request.resource.data: { "userId": "user123", ... }
     * @allow (get, update, delete) - Authenticated user accesses their own communication preferences.
     *   request.auth.uid: "user123"
     * @deny (create) - User attempts to create communication preferences under another user's ID.
     *   request.auth.uid: "user456"
     *   request.resource.data: { "userId": "user123", ... }
     * @deny (get, update, delete) - Unauthorized user attempts to access another user's communication preferences.
     *   request.auth.uid: "user456"
     * @principle Enforces document ownership for all operations on communication preferences.
     */
    match /users/{userId}/communicationPreference {
      // Reuse the isOwner and isSignedIn functions defined above
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && exists(/databases/$(database)/documents/users/$(userId)/communicationPreference);
      }

      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isExistingOwner(userId);
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }

    /**
     * @description Secures emergency contact data for a specific user, ensuring only the owner can access and modify it.
     * @path /users/{userId}/emergencyContacts/{emergencyContactId}
     * @allow (create) - Authenticated user creates an emergency contact under their user ID.
     *   request.auth.uid: "user123"
     *   request.resource.data: { "userId": "user123", ... }
     * @allow (get, update, delete) - Authenticated user accesses their own emergency contact data.
     *   request.auth.uid: "user123"
     * @deny (create) - User attempts to create an emergency contact under another user's ID.
     *   request.auth.uid: "user456"
     *   request.resource.data: { "userId": "user123", ... }
     * @deny (get, update, delete) - Unauthorized user attempts to access another user's emergency contact data.
     *   request.auth.uid: "user456"
     * @principle Enforces document ownership for all operations on emergency contact data.
     */
    match /users/{userId}/emergencyContacts/{emergencyContactId} {
      // Reuse the isOwner and isSignedIn functions defined above
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && exists(/databases/$(database)/documents/users/$(userId)/emergencyContacts/$(emergencyContactId));
      }

      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isExistingOwner(userId);
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }
  }
}